var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,u=(t,a,n)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[a]=n,s=(e,t)=>{for(var a in t||(t={}))l.call(t,a)&&u(e,a,t[a]);if(n)for(var a of n(t))r.call(t,a)&&u(e,a,t[a]);return e},o=(e,n)=>t(e,a(n)),i=(e,t,a)=>new Promise((n,l)=>{var r=e=>{try{s(a.next(e))}catch(t){l(t)}},u=e=>{try{s(a.throw(e))}catch(t){l(t)}},s=e=>e.done?n(e.value):Promise.resolve(e.value).then(r,u);s((a=a.apply(e,t)).next())});import{u as D,a as c,v as d}from"./useStorage-CghUNedP.js";import{g as v}from"./index-DLCvt2vX.js";import{r as g,c as f,A as m,b as w}from"./vue-vendor-GQR5GLLq.js";class y{calculateAvailableBudget(e,t,a){const n=e instanceof Date?e:new Date(e),l=t.startDate instanceof Date?t.startDate:new Date(t.startDate),r=this.calculateDailyBaseBudget(t,n),u=this.getPreviousDays(n,l);let s=0;for(const i of u){s+=r-this.getExpensesByDate(i,a).reduce((e,t)=>e+t.amount,0)}const o=s-this.getExpensesByDate(n,a).reduce((e,t)=>e+t.amount,0);return Math.max(0,o)}calculateDailyBaseBudget(e,t){const a=e.startDate instanceof Date?e.startDate:new Date(e.startDate),n=e.endDate instanceof Date?e.endDate:new Date(e.endDate),l=this.getDaysInPeriod(a,n);return e.monthlyAmount/l}reallocateBudget(e,t,a,n){const l=t instanceof Date?t:new Date(t),r=a.startDate instanceof Date?a.startDate:new Date(a.startDate),u=a.endDate instanceof Date?a.endDate:new Date(a.endDate),s=this.getRemainingDays(l,u),o=this.getTotalSpentInPeriod(r,l,n),i=s>0?(e-o)/s:0;return this.generateDailyAllocations(l,u,i,a,n)}generateDailyAllocations(e,t,a,n,l){const r=[],u=e instanceof Date?e:new Date(e),s=t instanceof Date?t:new Date(t),o=new Date(u);for(;o<=s;){this.formatDate(o);const e=this.getExpensesByDate(o,l).reduce((e,t)=>e+t.amount,0),t=this.calculateCarryOverAmount(o,n,l,a),u=a+t,s=u-e;r.push({date:new Date(o),baseAmount:a,carryOverAmount:t,availableAmount:u,spentAmount:e,remainingAmount:s}),o.setDate(o.getDate()+1)}return r}calculateCarryOverAmount(e,t,a,n){let l=0;const r=e instanceof Date?e:new Date(e),u=t.startDate instanceof Date?t.startDate:new Date(t.startDate),s=this.getPreviousDays(r,u);for(const o of s){l+=n-this.getExpensesByDate(o,a).reduce((e,t)=>e+t.amount,0)}return l}getPreviousDays(e,t){const a=[],n=e instanceof Date?e:new Date(e),l=t instanceof Date?t:new Date(t),r=new Date(l);for(;r<n;)a.push(new Date(r)),r.setDate(r.getDate()+1);return a}getExpensesByDate(e,t){const a=this.formatDate(e);return t.filter(e=>{try{return this.formatDate(e.date)===a}catch(t){return!1}})}getDaysInPeriod(e,t){const a=e instanceof Date?e:new Date(e),n=(t instanceof Date?t:new Date(t)).getTime()-a.getTime();return Math.ceil(n/864e5)+1}getRemainingDays(e,t){const a=e instanceof Date?e:new Date(e),n=(t instanceof Date?t:new Date(t)).getTime()-a.getTime();return Math.max(0,Math.ceil(n/864e5)+1)}getTotalSpentInPeriod(e,t,a){return a.filter(a=>{try{const n=a.date instanceof Date?a.date:new Date(a.date);return!isNaN(n.getTime())&&(n>=e&&n<=t)}catch(n){return!1}}).reduce((e,t)=>e+t.amount,0)}formatDate(e){const t=e instanceof Date?e:new Date(e);if(isNaN(t.getTime()))throw new Error(`Invalid date: ${e}`);return t.toISOString().split("T")[0]}validateBudgetAllocation(e,t){const a=[];e.monthlyAmount<=0&&a.push("月度预算金额必须大于0");const n=e.startDate instanceof Date?e.startDate:new Date(e.startDate),l=e.endDate instanceof Date?e.endDate:new Date(e.endDate);isNaN(n.getTime())||isNaN(l.getTime())?a.push("预算日期格式无效"):n>=l&&a.push("开始日期必须早于结束日期");const r=t.filter(t=>{try{const a=t.date instanceof Date?t.date:new Date(t.date);if(isNaN(a.getTime()))return!0;const n=e.startDate instanceof Date?e.startDate:new Date(e.startDate),l=e.endDate instanceof Date?e.endDate:new Date(e.endDate);return a<n||a>l}catch(a){return!0}});r.length>0&&a.push(`存在 ${r.length} 条消费记录的日期超出预算时间范围`);const u=t.filter(e=>e.amount<=0);return u.length>0&&a.push(`存在 ${u.length} 条消费记录的金额无效`),{isValid:0===a.length,errors:a}}}function h(){const e=D(),t=c(),a=new y,n=g(null),l=g(!1),r=g(null),u=f(()=>{var e;return(null==(e=n.value)?void 0:e.monthlyAmount)||0}),h=f(()=>n.value?a.calculateDailyBaseBudget(n.value,new Date):0),p=f(()=>{if(!n.value)return 0;const e=new Date;return a.calculateAvailableBudget(e,n.value,t.state.value)}),A=f(()=>{if(!n.value)return 0;const e=t.state.value,a=n.value.startDate instanceof Date?n.value.startDate:new Date(n.value.startDate),l=n.value.endDate instanceof Date?n.value.endDate:new Date(n.value.endDate);return e.filter(e=>{const t=e.date instanceof Date?e.date:new Date(e.date);return t>=a&&t<=l}).reduce((e,t)=>e+t.amount,0)}),B=f(()=>u.value-A.value),b=f(()=>{if(!n.value)return"active";const e=new Date>(n.value.endDate instanceof Date?n.value.endDate:new Date(n.value.endDate)),t=A.value>u.value;return e?"completed":t?"exceeded":"active"}),O=f(()=>{if(!n.value)return{totalBudget:0,totalSpent:0,remainingBudget:0,dailyAverage:0,daysRemaining:0,isOverBudget:!1};const e=new Date,t=(n.value.endDate instanceof Date?n.value.endDate:new Date(n.value.endDate)).getTime()-e.getTime(),a=Math.max(0,Math.ceil(t/864e5));return{totalBudget:u.value,totalSpent:A.value,remainingBudget:B.value,dailyAverage:h.value,daysRemaining:a,isOverBudget:A.value>u.value}}),T=f(()=>{if(!n.value)return[];const e=n.value.startDate instanceof Date?n.value.startDate:new Date(n.value.startDate),l=n.value.endDate instanceof Date?n.value.endDate:new Date(n.value.endDate);return a.generateDailyAllocations(e,l,h.value,n.value,t.state.value)}),M=f(()=>{const e=(new Date).toISOString().split("T")[0];return T.value.find(t=>(t.date instanceof Date?t.date:new Date(t.date)).toISOString().split("T")[0]===e)||null}),S=()=>i(null,null,function*(){if(n.value)try{const l=n.value.startDate instanceof Date?n.value.startDate:new Date(n.value.startDate),r=n.value.endDate instanceof Date?n.value.endDate:new Date(n.value.endDate),u=o(s({},n.value),{startDate:l,endDate:r,dailyAllocation:a.generateDailyAllocations(l,r,h.value,n.value,t.state.value),updatedAt:new Date}),i=E(e.state.value).map(e=>e.id===u.id?u:e);yield e.setValue(i),n.value=u}catch(l){r.value="更新预算分配失败"}}),x=()=>i(null,null,function*(){try{const t=new Date,a=e.state.value,l=E(a).find(e=>N(e.startDate,t));return n.value=l||null,l||null}catch(t){return r.value="获取当前预算失败",null}});function N(e,t){const a=e instanceof Date?e:new Date(e),n=t instanceof Date?t:new Date(t);return!isNaN(a.getTime())&&!isNaN(n.getTime())&&(a.getFullYear()===n.getFullYear()&&a.getMonth()===n.getMonth())}function P(e){var t;return o(s({},e),{startDate:e.startDate instanceof Date?e.startDate:new Date(e.startDate),endDate:e.endDate instanceof Date?e.endDate:new Date(e.endDate),createdAt:e.createdAt instanceof Date?e.createdAt:new Date(e.createdAt),updatedAt:e.updatedAt instanceof Date?e.updatedAt:new Date(e.updatedAt),dailyAllocation:(null==(t=e.dailyAllocation)?void 0:t.map(e=>o(s({},e),{date:e.date instanceof Date?e.date:new Date(e.date)})))||[]})}function E(e){return e.map(P)}return m(()=>t.state.value,()=>{n.value&&S()},{deep:!0}),x(),{currentBudget:w(n),isLoading:w(l),error:w(r),monthlyBudget:u,dailyBudget:h,availableBudget:p,totalSpent:A,remainingBudget:B,budgetStatus:b,budgetSummary:O,dailyAllocations:T,todayAllocation:M,setMonthlyBudget:u=>i(null,null,function*(){l.value=!0,r.value=null;try{const l=d(u);if(!l.isValid)throw new Error(l.errors.map(e=>e.message).join(", "));const r=new Date(u.startDate),o=new Date(r.getFullYear(),r.getMonth(),1),i=new Date(r.getFullYear(),r.getMonth()+1,0),D={id:v(),monthlyAmount:u.monthlyAmount,startDate:o,endDate:i,dailyAllocation:[],createdAt:new Date,updatedAt:new Date};D.dailyAllocation=a.generateDailyAllocations(o,i,u.monthlyAmount/(s=o,new Date(s.getFullYear(),s.getMonth()+1,0).getDate()),D,t.state.value);const c=E([...e.state.value]),g=c.findIndex(e=>N(e.startDate,o));g>=0?c[g]=D:c.push(D),yield e.setValue(c),n.value=D}catch(o){throw r.value=o instanceof Error?o.message:"设置预算失败",o}finally{l.value=!1}var s}),updateMonthlyBudget:u=>i(null,null,function*(){l.value=!0,r.value=null;try{if(!n.value)throw new Error("没有找到当前预算");const l=o(s(s({},n.value),u),{updatedAt:new Date});void 0!==u.monthlyAmount&&(l.dailyAllocation=a.reallocateBudget(u.monthlyAmount,new Date,n.value,t.state.value));const r=E(e.state.value).map(e=>e.id===l.id?l:e);yield e.setValue(r),n.value=l}catch(i){throw r.value=i instanceof Error?i.message:"更新预算失败",i}finally{l.value=!1}}),calculateAvailableBudget:e=>n.value?a.calculateAvailableBudget(e,n.value,t.state.value):0,updateBudgetAllocation:S,applyCarryOverMechanism:e=>n.value?a.calculateAvailableBudget(e,n.value,t.state.value):0,getCurrentMonthBudget:x,deleteBudget:t=>i(null,null,function*(){var a;l.value=!0,r.value=null;try{const l=e.state.value.filter(e=>e.id!==t);yield e.setValue(l),(null==(a=n.value)?void 0:a.id)===t&&(n.value=null)}catch(u){throw r.value=u instanceof Error?u.message:"删除预算失败",u}finally{l.value=!1}}),validateBudgetAllocation:()=>n.value?a.validateBudgetAllocation(n.value,t.state.value):{isValid:!1,errors:["没有找到当前预算"]},clearError:()=>{r.value=null}}}export{h as u};
