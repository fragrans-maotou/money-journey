var e=(e,t,a)=>new Promise((r,n)=>{var s=e=>{try{i(a.next(e))}catch(t){n(t)}},o=e=>{try{i(a.throw(e))}catch(t){n(t)}},i=e=>e.done?r(e.value):Promise.resolve(e.value).then(s,o);i((a=a.apply(e,t)).next())});import{r as t,c as a,A as r,b as n}from"./vue-vendor-GQR5GLLq.js";function s(e,t,a){return{field:e,message:t,code:a}}function o(e){return{isValid:!1,errors:e}}function i(e){const t=[];return"number"!=typeof e.monthlyAmount?t.push(s("monthlyAmount","月度预算金额不能为空","REQUIRED")):Number.isFinite(e.monthlyAmount)?e.monthlyAmount<=0?t.push(s("monthlyAmount","月度预算金额必须大于0","MIN_VALUE")):e.monthlyAmount>1e6&&t.push(s("monthlyAmount","月度预算金额不能超过100万","MAX_VALUE")):t.push(s("monthlyAmount","月度预算金额必须是有效数字","INVALID_NUMBER")),e.startDate&&e.startDate instanceof Date?isNaN(e.startDate.getTime())&&t.push(s("startDate","开始日期格式无效","INVALID_DATE")):t.push(s("startDate","开始日期不能为空","REQUIRED")),t.length>0?o(t):{isValid:!0,errors:[]}}function l(e){const t=[];return"number"!=typeof e.amount?t.push(s("amount","消费金额不能为空","REQUIRED")):Number.isFinite(e.amount)?e.amount<=0?t.push(s("amount","消费金额必须大于0","MIN_VALUE")):e.amount>1e5&&t.push(s("amount","单笔消费金额不能超过10万","MAX_VALUE")):t.push(s("amount","消费金额必须是有效数字","INVALID_NUMBER")),e.categoryId&&"string"==typeof e.categoryId&&0!==e.categoryId.trim().length||t.push(s("categoryId","消费分类不能为空","REQUIRED")),e.description&&"string"==typeof e.description&&0!==e.description.trim().length?e.description.length>200&&t.push(s("description","消费描述不能超过200个字符","MAX_LENGTH")):t.push(s("description","消费描述不能为空","REQUIRED")),!e.date||e.date instanceof Date&&!isNaN(e.date.getTime())||t.push(s("date","消费日期格式无效","INVALID_DATE")),t.length>0?o(t):{isValid:!0,errors:[]}}function u(e){const t=[];return e.name&&"string"==typeof e.name&&0!==e.name.trim().length?e.name.length>20&&t.push(s("name","分类名称不能超过20个字符","MAX_LENGTH")):t.push(s("name","分类名称不能为空","REQUIRED")),e.icon&&"string"==typeof e.icon&&0!==e.icon.trim().length||t.push(s("icon","分类图标不能为空","REQUIRED")),e.color&&"string"==typeof e.color?/^#[0-9A-Fa-f]{6}$/.test(e.color)||t.push(s("color","分类颜色格式无效，请使用十六进制格式（如 #FF0000）","INVALID_FORMAT")):t.push(s("color","分类颜色不能为空","REQUIRED")),t.length>0?o(t):{isValid:!0,errors:[]}}var c=Object.defineProperty,m=(e,t,a)=>((e,t,a)=>t in e?c(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a)(e,"symbol"!=typeof t?t+"":t,a);class p{static createBackup(e,t){try{const a=`${this.BACKUP_PREFIX}${e}`,r={originalKey:e,data:t,timestamp:(new Date).toISOString(),version:"1.0.0"};localStorage.setItem(a,JSON.stringify(r))}catch(a){}}static getBackup(e){try{const t=`${this.BACKUP_PREFIX}${e}`,a=localStorage.getItem(t);if(!a)return null;return JSON.parse(a).data}catch(t){return null}}static attemptRecovery(e){const t=this.getBackup(e);if(t)return t;try{const t=localStorage.getItem(e);if(t){const e=this.fixCorruptedJson(t);if(e)return JSON.parse(e)}}catch(a){}return null}static fixCorruptedJson(e){try{let t=e.replace(/,(\s*[}\]])/g,"$1").replace(/([{,]\s*)(\w+):/g,'$1"$2":').trim();return JSON.parse(t),t}catch(t){return null}}static recordRecoveryAttempt(e,t,a){try{const r={key:e,success:t,error:a?{type:a.type,message:a.message,timestamp:a.timestamp}:null,timestamp:(new Date).toISOString()},n=localStorage.getItem(this.RECOVERY_KEY),s=n?JSON.parse(n):[];s.push(r),s.length>10&&s.splice(0,s.length-10),localStorage.setItem(this.RECOVERY_KEY,JSON.stringify(s))}catch(r){}}}m(p,"BACKUP_PREFIX","backup_"),m(p,"RECOVERY_KEY","recovery_info");class y{static serialize(e){try{return JSON.stringify(e,this.dateReplacer)}catch(t){throw new g({type:"SERIALIZATION_ERROR",message:"Failed to serialize data",originalError:t,timestamp:new Date})}}static deserialize(e){try{return JSON.parse(e,this.dateReviver)}catch(t){throw new g({type:"DESERIALIZATION_ERROR",message:"Failed to deserialize data",originalError:t,timestamp:new Date})}}static dateReplacer(e,t){return t instanceof Date?{__type:"Date",value:t.toISOString()}:t}static dateReviver(e,t){return t&&"object"==typeof t&&"Date"===t.__type?new Date(t.value):t}}class g extends Error{constructor(e){super(e.message),m(this,"type"),m(this,"key"),m(this,"originalError"),m(this,"timestamp"),this.name="StorageError",this.type=e.type,this.key=e.key,this.originalError=e.originalError,this.timestamp=e.timestamp}}function h(s,o,i={}){const{enableBackup:l=!0,maxRetries:u=3,retryDelay:c=1e3,compressionEnabled:m=!1,encryptionEnabled:h=!1}=i,d=t(o),E=t(!1),f=t(null),R=t(null),I=a(()=>null!==f.value),v=a(()=>!I.value&&null!==R.value),D=()=>e(null,null,function*(){E.value=!0,f.value=null;try{const e=localStorage.getItem(s);if(!e)return d.value=o,o;const t=y.deserialize(e);return d.value=t,t}catch(e){const t=p.attemptRecovery(s);if(t)return d.value=t,p.recordRecoveryAttempt(s,!0),t;const a=e instanceof g?e:new g({type:"DESERIALIZATION_ERROR",message:`Failed to load data for key "${s}"`,key:s,originalError:e,timestamp:new Date});return f.value=a,p.recordRecoveryAttempt(s,!1,a),d.value=o,o}finally{E.value=!1}}),A=(t,a=0)=>e(null,null,function*(){try{l&&p.createBackup(s,d.value);const e=y.serialize(t);localStorage.setItem(s,e),d.value=t,R.value=new Date,f.value=null}catch(e){const r=e;let n;if(n="QuotaExceededError"===r.name||r.message.includes("quota")?new g({type:"QUOTA_EXCEEDED",message:"Storage quota exceeded. Please clear some data.",key:s,originalError:r,timestamp:new Date}):r.message.includes("access")?new g({type:"ACCESS_DENIED",message:"Access to localStorage denied",key:s,originalError:r,timestamp:new Date}):e instanceof g?e:new g({type:"UNKNOWN_ERROR",message:`Failed to save data for key "${s}"`,key:s,originalError:r,timestamp:new Date}),a<u)return yield new Promise(e=>setTimeout(e,c)),A(t,a+1);throw f.value=n,n}});return D(),r(d,t=>e(null,null,function*(){if(t!==o)try{yield A(t)}catch(e){}}),{deep:!0}),{state:n(d),isLoading:n(E),error:n(f),lastSaved:n(R),hasError:I,isHealthy:v,setValue:t=>e(null,null,function*(){yield A(t)}),updateValue:t=>e(null,null,function*(){const e=t(d.value);yield A(e)}),clearData:()=>{try{localStorage.removeItem(s),d.value=o,R.value=null,f.value=null}catch(e){f.value=new g({type:"ACCESS_DENIED",message:`Failed to clear data for key "${s}"`,key:s,originalError:e,timestamp:new Date})}},refreshData:()=>e(null,null,function*(){yield D()}),getStorageInfo:()=>{try{const e=localStorage.getItem(s);return{exists:null!==e,size:e?new Blob([e]).size:0,lastModified:R.value,hasBackup:null!==p.getBackup(s)}}catch(e){return{exists:!1,size:0,lastModified:null,hasBackup:!1,error:e}}},clearError:()=>{f.value=null},loadData:D,saveData:e=>A(e)}}function d(){return h("budgets",[],{enableBackup:!0,maxRetries:3})}function E(){return h("expenses",[],{enableBackup:!0,maxRetries:3})}function f(){return h("categories",[],{enableBackup:!0,maxRetries:3})}export{E as a,f as b,u as c,l as d,d as u,i as v};
