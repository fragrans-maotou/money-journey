var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,i=(t,a,n)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[a]=n,s=(e,t)=>{for(var a in t||(t={}))r.call(t,a)&&i(e,a,t[a]);if(n)for(var a of n(t))o.call(t,a)&&i(e,a,t[a]);return e},l=(e,n)=>t(e,a(n)),u=(e,t,a)=>new Promise((n,r)=>{var o=e=>{try{s(a.next(e))}catch(t){r(t)}},i=e=>{try{s(a.throw(e))}catch(t){r(t)}},s=e=>e.done?n(e.value):Promise.resolve(e.value).then(o,i);s((a=a.apply(e,t)).next())});import{D as c,g as d}from"./index-DLCvt2vX.js";import{a as m,b as f,c as g,d as y}from"./useStorage-CghUNedP.js";import{r as v,c as w,b as D}from"./vue-vendor-GQR5GLLq.js";function p(){const e=m(),t=f(),a=v(!1),n=v(null),r=v({}),o=w(()=>e.state.value),i=w(()=>t.state.value),p=w(()=>{let e=o.value;const t=r.value;if(t.categoryId&&(e=e.filter(e=>e.categoryId===t.categoryId)),t.startDate&&(e=e.filter(e=>{try{const a=e.date instanceof Date?e.date:new Date(e.date),n=t.startDate instanceof Date?t.startDate:new Date(t.startDate);return!isNaN(a.getTime())&&!isNaN(n.getTime())&&a>=n}catch(a){return!1}})),t.endDate&&(e=e.filter(e=>{try{const a=e.date instanceof Date?e.date:new Date(e.date),n=t.endDate instanceof Date?t.endDate:new Date(t.endDate);return!isNaN(a.getTime())&&!isNaN(n.getTime())&&a<=n}catch(a){return!1}})),void 0!==t.minAmount&&(e=e.filter(e=>e.amount>=t.minAmount)),void 0!==t.maxAmount&&(e=e.filter(e=>e.amount<=t.maxAmount)),t.description){const a=t.description.toLowerCase();e=e.filter(e=>e.description.toLowerCase().includes(a))}return e.sort((e,t)=>{const a=e.date instanceof Date?e.date:new Date(e.date);return(t.date instanceof Date?t.date:new Date(t.date)).getTime()-a.getTime()})}),h=w(()=>{const e=(new Date).toISOString().split("T")[0];return o.value.filter(t=>{try{const a=t.date instanceof Date?t.date:new Date(t.date);if(isNaN(a.getTime()))return!1;return a.toISOString().split("T")[0]===e}catch(a){return!1}})}),E=w(()=>h.value.reduce((e,t)=>e+t.amount,0)),I=w(()=>{const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1),a=new Date(e.getFullYear(),e.getMonth()+1,0);return o.value.filter(e=>{try{const n=e.date instanceof Date?e.date:new Date(e.date);return!isNaN(n.getTime())&&(n>=t&&n<=a)}catch(n){return!1}})}),N=w(()=>I.value.reduce((e,t)=>e+t.amount,0)),T=w(()=>{const e=new Map;return p.value.forEach(t=>{const a=i.value.find(e=>e.id===t.categoryId),n=(null==a?void 0:a.name)||"未知分类";e.has(t.categoryId)||e.set(t.categoryId,{categoryId:t.categoryId,categoryName:n,amount:0,count:0,expenses:[]});const r=e.get(t.categoryId);r.amount+=t.amount,r.count+=1,r.expenses.push(t)}),Array.from(e.values()).sort((e,t)=>t.amount-e.amount)}),x=w(()=>o.value.sort((e,t)=>{const a=e.createdAt instanceof Date?e.createdAt:new Date(e.createdAt);return(t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt)).getTime()-a.getTime()}).slice(0,10)),A=()=>u(null,null,function*(){try{if(0===i.value.length){const e=c.map(e=>l(s({},e),{id:d()}));yield t.setValue(e)}}catch(e){}}),C=(e,t)=>{const a=e instanceof Date?e:new Date(e),n=t instanceof Date?t:new Date(t);return o.value.filter(e=>{try{const t=e.date instanceof Date?e.date:new Date(e.date);return!isNaN(t.getTime())&&(t>=a&&t<=n)}catch(t){return!1}})};return A(),{isLoading:D(a),error:D(n),currentFilter:D(r),expenses:o,categories:i,filteredExpenses:p,todayExpenses:h,todayTotal:E,thisMonthExpenses:I,thisMonthTotal:N,expensesByCategory:T,recentExpenses:x,addExpense:t=>u(null,null,function*(){a.value=!0,n.value=null;try{const a=y(t);if(!a.isValid)throw new Error(a.errors.map(e=>e.message).join(", "));if(!i.value.some(e=>e.id===t.categoryId))throw new Error("指定的消费分类不存在");const n={id:d(),amount:t.amount,categoryId:t.categoryId,description:t.description,date:t.date||new Date,createdAt:new Date,updatedAt:new Date},r=[...o.value,n];return yield e.setValue(r),n}catch(r){throw n.value=r instanceof Error?r.message:"添加消费记录失败",r}finally{a.value=!1}}),updateExpense:(t,r)=>u(null,null,function*(){a.value=!0,n.value=null;try{const a=o.value.find(e=>e.id===t);if(!a)throw new Error("消费记录不存在");if(r.categoryId){if(!i.value.some(e=>e.id===r.categoryId))throw new Error("指定的消费分类不存在")}const n=l(s(s({},a),r),{updatedAt:new Date}),u=y({amount:n.amount,categoryId:n.categoryId,description:n.description,date:n.date});if(!u.isValid)throw new Error(u.errors.map(e=>e.message).join(", "));const c=o.value.map(e=>e.id===t?n:e);return yield e.setValue(c),n}catch(u){throw n.value=u instanceof Error?u.message:"更新消费记录失败",u}finally{a.value=!1}}),deleteExpense:t=>u(null,null,function*(){a.value=!0,n.value=null;try{if(!o.value.some(e=>e.id===t))throw new Error("消费记录不存在");const a=o.value.filter(e=>e.id!==t);yield e.setValue(a)}catch(r){throw n.value=r instanceof Error?r.message:"删除消费记录失败",r}finally{a.value=!1}}),deleteExpenses:t=>u(null,null,function*(){a.value=!0,n.value=null;try{const a=o.value.filter(e=>!t.includes(e.id));yield e.setValue(a)}catch(r){throw n.value=r instanceof Error?r.message:"批量删除消费记录失败",r}finally{a.value=!1}}),initializeDefaultCategories:A,addCategory:e=>u(null,null,function*(){a.value=!0,n.value=null;try{const a=g(e);if(!a.isValid)throw new Error(a.errors.map(e=>e.message).join(", "));if(i.value.some(t=>t.name.toLowerCase()===e.name.toLowerCase()))throw new Error("分类名称已存在");const n={id:d(),name:e.name,icon:e.icon,color:e.color,isDefault:!1},r=[...i.value,n];return yield t.setValue(r),n}catch(r){throw n.value=r instanceof Error?r.message:"添加分类失败",r}finally{a.value=!1}}),updateCategory:(e,r)=>u(null,null,function*(){a.value=!0,n.value=null;try{const a=i.value.find(t=>t.id===e);if(!a)throw new Error("分类不存在");if(r.name){if(i.value.some(t=>t.id!==e&&t.name.toLowerCase()===r.name.toLowerCase()))throw new Error("分类名称已存在")}const n=s(s({},a),r),o=g({name:n.name,icon:n.icon,color:n.color});if(!o.isValid)throw new Error(o.errors.map(e=>e.message).join(", "));const l=i.value.map(t=>t.id===e?n:t);return yield t.setValue(l),n}catch(o){throw n.value=o instanceof Error?o.message:"更新分类失败",o}finally{a.value=!1}}),deleteCategory:e=>u(null,null,function*(){a.value=!0,n.value=null;try{const a=i.value.find(t=>t.id===e);if(!a)throw new Error("分类不存在");if(o.value.some(t=>t.categoryId===e))throw new Error("该分类下还有消费记录，无法删除");if(a.isDefault)throw new Error("不能删除默认分类");const n=i.value.filter(t=>t.id!==e);yield t.setValue(n)}catch(r){throw n.value=r instanceof Error?r.message:"删除分类失败",r}finally{a.value=!1}}),getExpensesByDate:e=>{const t=(e instanceof Date?e:new Date(e)).toISOString().split("T")[0];return o.value.filter(e=>{try{const a=e.date instanceof Date?e.date:new Date(e.date);if(isNaN(a.getTime()))return!1;return a.toISOString().split("T")[0]===t}catch(a){return!1}})},getExpensesByDateRange:C,getExpensesByCategory:e=>o.value.filter(t=>t.categoryId===e),getExpensesByAmountRange:(e,t)=>o.value.filter(a=>a.amount>=e&&a.amount<=t),searchExpenses:e=>{const t=e.toLowerCase();return o.value.filter(e=>{const a=i.value.find(t=>t.id===e.categoryId),n=(null==a?void 0:a.name.toLowerCase())||"";return e.description.toLowerCase().includes(t)||n.includes(t)})},setFilter:e=>{r.value=s({},e)},clearFilter:()=>{r.value={}},applyFilter:e=>{let t=o.value;if(e.categoryId&&(t=t.filter(t=>t.categoryId===e.categoryId)),e.startDate&&(t=t.filter(t=>{try{const a=t.date instanceof Date?t.date:new Date(t.date),n=e.startDate instanceof Date?e.startDate:new Date(e.startDate);return!isNaN(a.getTime())&&!isNaN(n.getTime())&&a>=n}catch(a){return!1}})),e.endDate&&(t=t.filter(t=>{try{const a=t.date instanceof Date?t.date:new Date(t.date),n=e.endDate instanceof Date?e.endDate:new Date(e.endDate);return!isNaN(a.getTime())&&!isNaN(n.getTime())&&a<=n}catch(a){return!1}})),void 0!==e.minAmount&&(t=t.filter(t=>t.amount>=e.minAmount)),void 0!==e.maxAmount&&(t=t.filter(t=>t.amount<=e.maxAmount)),e.description){const a=e.description.toLowerCase();t=t.filter(e=>e.description.toLowerCase().includes(a))}return t.sort((e,t)=>{const a=e.date instanceof Date?e.date:new Date(e.date);return(t.date instanceof Date?t.date:new Date(t.date)).getTime()-a.getTime()})},getExpenseStatistics:(e,t)=>{const a=C(e,t),n=a.reduce((e,t)=>e+t.amount,0),r=new Map;a.forEach(e=>{r.has(e.categoryId)||r.set(e.categoryId,{amount:0,count:0});const t=r.get(e.categoryId);t.amount+=e.amount,t.count+=1});const o=new Map;return a.forEach(e=>{try{const t=e.date instanceof Date?e.date:new Date(e.date);if(!isNaN(t.getTime())){const a=t.toISOString().split("T")[0];o.set(a,(o.get(a)||0)+e.amount)}}catch(t){}}),{totalAmount:n,totalCount:a.length,averageAmount:a.length>0?n/a.length:0,categoryStats:Array.from(r.entries()).map(([e,t])=>{const a=i.value.find(t=>t.id===e);return{categoryId:e,categoryName:(null==a?void 0:a.name)||"未知分类",amount:t.amount,count:t.count,percentage:n>0?t.amount/n*100:0}}).sort((e,t)=>t.amount-e.amount),dailyStats:Array.from(o.entries()).map(([e,t])=>({date:new Date(e),amount:t})).sort((e,t)=>{const a=e.date instanceof Date?e.date:new Date(e.date),n=t.date instanceof Date?t.date:new Date(t.date);return a.getTime()-n.getTime()})}},getCategoryById:e=>i.value.find(t=>t.id===e),getExpenseById:e=>o.value.find(t=>t.id===e),clearError:()=>{n.value=null}}}export{p as u};
